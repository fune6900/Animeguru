<% content_for(:title, t('.title')) %>

<%# 🔹 検索フォーム & 現在地ボタン（上部中央） %>
<div id="search-container" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-10 flex justify-center space-x-2 w-11/12 sm:w-2/3">
  <input id="pac-input" class="controls input input-bordered input-sm w-full" type="text" placeholder="聖地名">
  <button id="current-location-btn" class="btn btn-sm btn-primary text-white">現在地</button>
</div>

<%# 🔹 レイアウト：マップ + 聖地メモ一覧を横並び or 縦並び（レスポンシブ） %>
<div class="flex flex-col md:flex-row h-[90vh] mt-20 px-4 gap-4">
  <%# 🔹 地図表示領域 %>
  <div id="map" class="w-full md:w-2/3 h-96 md:h-full rounded shadow"></div>

  <%# 🔹 聖地メモ一覧（スクロール可） %>
  <div class="w-full md:w-1/3 overflow-y-auto h-96 md:h-full bg-white rounded shadow p-4">
    <h2 class="text-lg font-bold mb-2">聖地メモ一覧</h2>
    <% @seichi_memos.each do |memo| %>
      <div class="border-b py-2">
        <p class="text-sm text-gray-600"><%= memo.anime.title %>（<%= memo.place.name %>）</p>
        <p class="font-semibold"><%= memo.title %></p>
        <p class="text-xs text-gray-500"><%= memo.place.address %></p>
        <%= link_to '詳細を見る', seichi_memo_path(memo), class: "text-blue-600 hover:underline text-sm" %>
      </div>
    <% end %>
  </div>
</div>

<%# 🔹 Google Maps の表示用スクリプト %>
<script>
  let map;

  function initMap() {
    const center = { lat: 35.6803997, lng: 139.7690174 }; // 東京駅

    map = new google.maps.Map(document.getElementById("map"), {
      center: center,
      zoom: 10,
      gestureHandling: 'greedy',
    });

    const input = document.getElementById("pac-input");
    const searchBox = new google.maps.places.SearchBox(input);

    // 🔹 検索範囲制限
    map.addListener("bounds_changed", () => {
      searchBox.setBounds(map.getBounds());
    });

    // 🔹 現在地ボタン
    document.getElementById("current-location-btn").addEventListener("click", () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
          const pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          map.setCenter(pos);
          new google.maps.Marker({
            position: pos,
            map: map,
            icon: 'https://www.google.com/mapfiles/marker.png'
          });
        }, () => {
          alert("位置情報の取得に失敗しました。");
        });
      } else {
        alert("お使いのブラウザでは位置情報が利用できません。");
      }
    });

    // 🔹 聖地メモのマーカーを表示
    <% @seichi_memos.each do |memo| %>
      new google.maps.Marker({
        position: {
          lat: <%= memo.place.latitude %>,
          lng: <%= memo.place.longitude %>
        },
        map: map,
        title: "<%= j memo.title %>"
      });
    <% end %>
  }

  // 🔹 グローバル登録
  window.initMap = initMap;
</script>

<%# 🔹 Google Maps API 読み込み（APIキーは .env で管理） %>
<script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAPS_API_KEY'] %>&libraries=places&callback=initMap" async defer></script>
